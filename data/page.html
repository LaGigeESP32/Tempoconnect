<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TempoConnect</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f4f4;
      color: #333;
    }

    .header {
      background: #2196F3;
      color: white;
      padding: 0.5em;
      font-size: 1.5em;
      text-align: center;
    }

    .button-bar {
      text-align: center;
      margin: 1em 0;
    }

    .button-bar a {
      text-decoration: none;
      background: #e0e0e0;
      color: #000;
      padding: 0.5em 1em;
      margin: 0 0.5em;
      border-radius: 5px;
      display: inline-block;
      transition: background 0.3s;
    }

    .button-bar a:hover {
      background: #ccc;
    }

    .container {
      max-width: 600px;
      margin: auto;
      padding: 1.5em;
      background: white;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
	
	.title1 {
	font-size: 1.2em;
	text-align: center;
	margin-top: 0;
	margin-bottom: 1em;
	}

    .title {
      font-size: 0.9em;
      margin-bottom: 0.5em;
      text-align: center;
    }

	.center-text {
	text-align: center;
	margin: 0.5em 0;
	}

    .circle {
      width: 40px;
      height: 40px;
      margin: 10px auto;
      border-radius: 50%;
      display: inline-block;
      border: 2px solid #333;
    }

    .CLIN {
      animation: clignoter 0.5s infinite;
    }

    @keyframes clignoter {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }

    .BLEU { background-color: blue; }
    .BLANC { background-color: white; }
    .ROUGE { background-color: red; }
    .JAUNE { background-color: yellow; }
    .NUIT { background-color: #191970; }
    .NON_DEFINI { background-color: green; }

    .row {
      display: flex;
      justify-content: space-around;
      margin: 1em 0;
      text-align: center;
    }

    .column {
      flex: 1;
    }

    input[type=range] {
      width: 100%;
      margin: 0.5em 0 1em 0;
    }

    label.option-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 1em 0;
      font-size: 1em;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 20px;
      margin-left: 10px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 34px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: #2196F3;
    }

    input:checked + .slider:before {
      transform: translateX(20px);
    }

    select {
      width: 100%;
      padding: 0.5em;
      font-size: 1em;
      margin-top: 0.3em;
      border: 1px solid #ccc;
      border-radius: 6px;
      background-color: #fefefe;
    }
  </style>

</head>
<body>
  <div class="header">Tempo Connect</div>

  <div class="button-bar">
    <a href="/wifi">Wifi</a>
    <a href="#" onclick="restart()">Redémarrer</a>
  </div>

  <div class="container">
	<div class="title1"><span id="webDateTime">Connexion au TempoConnect...</span></div>
		<p class="center-text">Synchronisation RTE <span id="WebLastSync"></span></p>
		<p class="center-text">Dernier client <span id="ClientConnect"></span></p>

    <div class="row">
      <div class="column title">Aujourd'hui</div>
      <div class="column title">Demain</div>
      <div class="column title"><span id='WebHPHCtext'>--</span></div>
      <div class="column title">Vigilance</div>
    </div>
    <div class="row">
      <div class="column"><div id="WebJourJ" class="circle BLEU CLIN"></div></div>
      <div class="column"><div id="WebJourJ1" class="circle NON_DEFINI"></div></div>
      <div class="column"><div id="WebHPHCLed" class="circle CLIN"></div></div>
      <div class="column"><div id="WebVigilance" class="circle CLIN"></div></div>
    </div>

    <label for="LumLedJour">Luminosité jour des Led</label>
    <input type="range" id="LumLedJour" min="1" max="100" value="50" onchange="updateVars()">

    <label for="LumLedNuit">Luminosité nuit des Led</label>
    <input type="range" id="LumLedNuit" min="1" max="100" value="50" onchange="updateVars()">

    <label class="option-label">Activer les leds des jours
      <span class="switch">
        <input type="checkbox" id="modeLed" checked onchange="updateVars()">
        <span class="slider"></span>
      </span>
    </label>

    <label class="option-label">Activer la led HP/HC
      <span class="switch">
        <input type="checkbox" id="ModeHPHC" checked onchange="updateVars()">
        <span class="slider"></span>
      </span>
    </label>

    <label class="option-label">Activer la led de vigilance
      <span class="switch">
        <input type="checkbox" id="ModeSurveil" checked onchange="updateVars()">
        <span class="slider"></span>
      </span>
    </label>

    <label class="option-label">Activer l'économie d'énergie
      <span class="switch">
        <input type="checkbox" id="ModeWifiSave" checked onchange="updateVars()">
        <span class="slider"></span>
      </span>
    </label>

    <label class="option-label">Activer la sonde de température
      <span class="switch">
        <input type="checkbox" id="sondTemp" checked onchange="updateVars()">
        <span class="slider"></span>
      </span>
    </label>

    <label for="ModeVeille">Allumage des leds</label>
    <select id="ModeVeille" onchange="updateVars()">
      <option value="0">Oui</option>
      <option value="1">Non</option>
      <option value="2">Uniquement en saison</option>
      <option value="3">Uniquement en jour rouge</option>
	</select>
	<br><br>
    <label for="NUM_PIXELS">Configuration des leds</label>
    <select id="NUM_PIXELS" onchange="updateVars()">
      <option value="3">3 leds</option>
      <option value="4">4 leds</option>
    </select>
  </div>

  <script>
    var gateway = `ws://192.168.0.124/ws`;
//    var gateway = `ws://${window.location.hostname}/ws`;

    var websocket;
    var outConnect = false;

    window.addEventListener('load', function() { initWebSocket(); });

    function initWebSocket() {
      websocket = new WebSocket(gateway);
      websocket.onopen = () => { outConnect = true; };
      websocket.onclose = () => { outConnect = false; };
      websocket.onmessage = onMessage;
    }

    function updateVars() {
      const data = {
        lumLedJour: parseInt(document.getElementById("LumLedJour").value),
        lumLedNuit: parseInt(document.getElementById("LumLedNuit").value),
        modeLed: document.getElementById("modeLed").checked,
        ModeHPHC: document.getElementById("ModeHPHC").checked,
        ModeSurveil: document.getElementById("ModeSurveil").checked,
        ModeWifiSave: document.getElementById("ModeWifiSave").checked,
        sondTemp: document.getElementById("sondTemp").checked,
        ModeVeille: parseInt(document.getElementById("ModeVeille").value),
        NUM_PIXELS: parseInt(document.getElementById("NUM_PIXELS").value)
      };
      websocket.send(JSON.stringify(data));
    }

    function forceClassUpdate(id, newClass) {
      const el = document.getElementById(id);
      el.className = ''; // clear
      void el.offsetWidth; // trigger reflow
      el.className = newClass; // set
    }

    function onMessage(event) {
  const data = JSON.parse(event.data);
      document.getElementById('webDateTime').innerText = data.webDateTime;
      document.getElementById('WebLastSync').innerText = data.WebLastSync;
      document.getElementById('WebHPHCtext').innerText = data.WebHPHCtext;
      document.getElementById('ClientConnect').innerText = data.ClientConnect;

      forceClassUpdate('WebJourJ', data.WebJourJ);
      forceClassUpdate('WebJourJ1', data.WebJourJ1);
      forceClassUpdate('WebHPHCLed', data.WebHPHCLed);
      forceClassUpdate('WebVigilance', data.WebVigilance);

      document.getElementById('LumLedJour').value = data.lumLedJour;
      document.getElementById('LumLedNuit').value = data.lumLedNuit;
      document.getElementById('modeLed').checked = data.modeLed;
      document.getElementById('ModeHPHC').checked = data.ModeHPHC;
      document.getElementById('ModeSurveil').checked = data.ModeSurveil;
      document.getElementById('ModeWifiSave').checked = data.ModeWifiSave;
      document.getElementById('ModeVeille').value = data.ModeVeille;
      document.getElementById('sondTemp').checked = data.sondTemp;
      document.getElementById('NUM_PIXELS').value = data.NUM_PIXELS;
    }

    function restart() {
      fetch('/restart');
    }

    function reConnect() {
      if (!outConnect) initWebSocket();
    }

    setInterval(reConnect, 2000);
  </script>
</body>
</html>